# æŠ–éŸ³å¯¹æ¥å®ç°è¿›å±•

## âœ… å·²å®Œæˆ

### 1. ä¿®æ”¹ DouyinChannel æ”¯æŒ access_token
**æ–‡ä»¶**ï¼š`proxy/channel/douyin.go`

#### ä¿®æ”¹ç‚¹1ï¼šStart æ–¹æ³•ç­¾å
```go
// ä¹‹å‰
func (d *DouyinChannel) Start(roomID string) error

// ç°åœ¨
func (d *DouyinChannel) Start(roomID, accessToken string) error
```

#### ä¿®æ”¹ç‚¹2ï¼šWebSocket è¿æ¥å¤´
```go
// æ·»åŠ  Authorization å¤´
if d.accessToken != "" {
    headers.Set("Authorization", "Bearer "+d.accessToken)
}
```

### 2. OAuth æµç¨‹å·²æœ‰
**æ–‡ä»¶**ï¼š`proxy/oauth/oauth.go`

- âœ… GetAuthURL() - ç”ŸæˆæˆæƒURL
- âœ… ExchangeCodeForToken() - æ¢å–token
- âœ… GetUserInfo() - è·å–ç”¨æˆ·ä¿¡æ¯
- âœ… RefreshToken() - åˆ·æ–°token

## ğŸ”§ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. å®Œå–„ä¸»ç¨‹åºçš„OAuthå›è°ƒå¤„ç† â° ç«‹å³

#### éœ€è¦ä¿®æ”¹ `proxy/main.go`
```go
http.HandleFunc("/oauth/callback", func(w http.ResponseWriter, r *http.Request) {
    code := r.URL.Query().Get("code")
    state := r.URL.Query().Get("state")
    
    // 1. ç”¨codeæ¢å–access_token
    token, err := douyinOAuth.ExchangeCodeForToken(code)
    
    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    userInfo, err := douyinOAuth.GetUserInfo(token.AccessToken)
    
    // 3. ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆæˆ–å†…å­˜ï¼‰
    saveAccount(token, userInfo)
    
    // 4. è¿”å›å‰ç«¯
    response := map[string]interface{}{
        "success": true,
        "data": {
            "access_token": token.AccessToken,
            "user_info": userInfo,
        },
    }
    json.NewEncoder(w).Encode(response)
})
```

### 2. æ·»åŠ å…¥å£æ”¯æŒåŠ¨æ€å¯åŠ¨æ¸ é“ â° ç¬¬äºŒæ­¥

#### éœ€è¦æ·»åŠ  API å¯åŠ¨æŒ‡å®šæ¸ é“
```go
http.HandleFunc("/api/channel/start", func(w http.ResponseWriter, r *http.Request) {
    // ä»è¯·æ±‚ä¸­è·å–å‚æ•°
    roomID := r.FormValue("room_id")
    accessToken := r.FormValue("access_token")
    
    // å¯åŠ¨æŠ–éŸ³æ¸ é“
    douyinChannel, _ := channel.NewDouyinChannel(pipeline)
    douyinChannel.Start(roomID, accessToken)
    
    // è¿”å›æˆåŠŸ
    w.WriteHeader(http.StatusOK)
})
```

### 3. å­˜å‚¨ access_token â° ç¬¬ä¸‰æ­¥

#### ä¸´æ—¶æ–¹æ¡ˆï¼šå†…å­˜å­˜å‚¨
```go
var accountMap = make(map[string]Account)

type Account struct {
    AccessToken  string
    RefreshToken string
    UserInfo     oauth.UserInfo
    RoomID       string
    CreatedAt    time.Time
}

func saveAccount(token *oauth.OAuthToken, userInfo *oauth.UserInfo) {
    accountMap[userInfo.OpenID] = Account{
        AccessToken:  token.AccessToken,
        RefreshToken: token.RefreshToken,
        UserInfo:     *userInfo,
        CreatedAt:    time.Now(),
    }
}
```

#### å®Œæ•´æ–¹æ¡ˆï¼šæ•°æ®åº“å­˜å‚¨
```sql
CREATE TABLE douyin_accounts (
    id VARCHAR(50) PRIMARY KEY,
    open_id VARCHAR(100) UNIQUE NOT NULL,
    access_token TEXT NOT NULL,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    room_id VARCHAR(100),
    user_info JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4. å‰ç«¯é›†æˆ â° ç¬¬å››æ­¥

#### å‰ç«¯éœ€è¦è°ƒç”¨
```typescript
// 1. è·å–æˆæƒURL
const authURL = await api.get('/proxy/oauth/douyin');

// 2. æ˜¾ç¤ºäºŒç»´ç 
<QRCode value={authURL} />

// 3. ç›‘å¬å›è°ƒ
// ç”¨æˆ·æˆæƒåï¼Œå‰ç«¯æ¥æ”¶å›è°ƒæ•°æ®

// 4. å¯åŠ¨ç›‘å¬
await api.post('/api/channel/start', {
    room_id: selectedRoomID,
    access_token: accessToken
});
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1ï¼šæµ‹è¯• OAuth æµç¨‹
```bash
# 1. å¯åŠ¨ä»£ç†æœåŠ¡
cd proxy
go run main.go

# 2. è®¿é—®æˆæƒURL
curl http://localhost:8080/oauth/douyin

# 3. åº”è¯¥é‡å®šå‘åˆ°æŠ–éŸ³æˆæƒé¡µé¢
```

### æ­¥éª¤2ï¼šå®Œæ•´æˆæƒæµç¨‹
```bash
# 1. ç”¨æˆ·æ‰«ç æˆæƒ
# 2. å›è°ƒåˆ° /oauth/callback?code=xxx
# 3. åº”è¯¥è¿”å› access_token
```

### æ­¥éª¤3ï¼šæµ‹è¯• WebSocket è¿æ¥
```bash
# 1. å¯åŠ¨æ¸ é“ï¼ˆå‡è®¾æœ‰access_tokenï¼‰
curl -X POST http://localhost:8080/api/channel/start \
  -d "room_id=123456789" \
  -d "access_token=abc123..."

# 2. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°
# "ğŸµ æŠ–éŸ³æ¸ é“å¯åŠ¨ï¼Œæˆ¿é—´ID: 123456789"
# "âœ… æŠ–éŸ³WebSocketè¿æ¥æˆåŠŸ"
```

## ğŸ“‹ å¾…åŠäº‹é¡¹

### é«˜ä¼˜å…ˆçº§
- [ ] å®Œå–„ OAuth å›è°ƒå¤„ç†
- [ ] æ·»åŠ åŠ¨æ€å¯åŠ¨æ¸ é“API
- [ ] å­˜å‚¨ access_token
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹

### ä¸­ä¼˜å…ˆçº§
- [ ] å®ç°æ•°æ®åº“å­˜å‚¨
- [ ] æ·»åŠ é”™è¯¯å¤„ç†
- [ ] å®ç° token åˆ·æ–°æœºåˆ¶
- [ ] æ·»åŠ æ—¥å¿—è®°å½•

### ä½ä¼˜å…ˆçº§
- [ ] å®ç°å¤šè´¦å·ç®¡ç†
- [ ] æ·»åŠ ç›‘æ§å’Œå‘Šè­¦
- [ ] æ€§èƒ½ä¼˜åŒ–

## ğŸ¯ å½“å‰çŠ¶æ€

### è¿›åº¦
- âœ… ä»£ç ä¿®æ”¹ï¼šamdStart æ–¹æ³•æ”¯æŒ access_token
- âœ… WebSocketï¼šæ·»åŠ  Authorization å¤´
- âœ… OAuthï¼šå·²æœ‰å®Œæ•´æµç¨‹
- â³ å›è°ƒå¤„ç†ï¼šéœ€è¦å®Œå–„
- â³ åŠ¨æ€å¯åŠ¨ï¼šéœ€è¦æ·»åŠ API
- â³ å­˜å‚¨æ–¹æ¡ˆï¼šéœ€è¦å®ç°

### ä¸‹ä¸€æ­¥
ç«‹å³å®Œå–„ OAuth å›è°ƒå¤„ç†ï¼Œä¿å­˜ access_tokenã€‚

---

**æ›´æ–°æ—¶é—´**ï¼š2025-10-27  
**çŠ¶æ€**ï¼šå¼€å‘ä¸­
