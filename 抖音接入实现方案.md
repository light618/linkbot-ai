# 抖音接入完整实现方案

## 🎯 目标
实现完整的抖音接入流程：
1. ✅ 扫码绑定账号（OAuth2授权）
2. ✅ 监听直播间评论消息
3. ✅ 监听私信消息
4. ✅ 通过大模型生成回复
5. ✅ 自动发送回复

## 📋 实现步骤

### 第一步：完善OAuth2授权流程

**前端** (`linkbot-ai-frontend/src/pages/Channels/DouyinPage.tsx`)
- 已有扫码授权按钮
- 需要连接后端API获取授权URL
- 处理授权回调

**后端** (`linkbot-ai/backend/src/routes/simple.ts`)
- ✅ 已添加 `/channels/douyin/oauth/url` 接口
- ✅ 已添加 `/channels/douyin/oauth/callback` 接口
- 需要连接Go服务的OAuth接口

**Go服务** (`linkbot-ai/main.go`)
- ✅ 已有OAuth授权流程
- ✅ 已有授权回调处理
- 需要完善账号存储和状态管理

### 第二步：实现消息监听

**Go服务** (`linkbot-ai/channel/douyin.go`)
- ✅ 已有 `pollLiveComments()` 轮询直播间评论
- ✅ 已有 `pollVideoComments()` 轮询短视频评论
- ⏳ 需要添加私信消息监听
- ⏳ 需要完善消息去重和状态管理

**消息类型**:
1. 直播间评论 - 通过API轮询获取
2. 短视频评论 - 通过API轮询获取
3. 私信消息 - 需要实现WebSocket或API轮询

### 第三步：集成AI大模型

**Go服务** (`linkbot-ai/pipeline/pipeline.go`)
- ✅ 已有 `generateAIReply()` 方法
- ✅ 已集成Coze API
- ⏳ 需要完善错误处理和降级策略
- ⏳ 需要添加OpenAI作为备选

**后端API** (`linkbot-ai/backend/src/routes/ai.ts`)
- ✅ 已有 `/ai/reply` 接口
- ✅ 已集成Coze API
- ⏳ 需要完善关键词匹配
- ⏳ 需要添加缓存机制

### 第四步：实现自动回复

**Go服务** (`linkbot-ai/channel/douyin.go`)
- ✅ 已有 `SendVideoCommentReply()` 方法
- ✅ 已有 `SendLiveCommentReply()` 方法
- ⏳ 需要实现私信回复方法
- ⏳ 需要完善错误重试机制

**Pipeline** (`linkbot-ai/pipeline/pipeline.go`)
- ✅ 已有 `sendReply()` 方法
- ✅ 已连接回复发送器
- ⏳ 需要完善回复内容审核
- ⏳ 需要添加回复日志

## 🔧 技术实现细节

### 1. OAuth2授权流程

```
前端 → 后端API → Go服务 → 抖音开放平台
  ↓
获取授权URL → 显示二维码 → 用户扫码 → 授权回调 → 获取access_token → 存储账号信息
```

### 2. 消息监听流程

```
Go服务轮询 → 抖音API → 获取新消息 → 去重处理 → 创建事件 → Pipeline处理
```

### 3. AI回复流程

```
收到消息 → Pipeline处理 → 调用Coze API → 生成回复 → 内容审核 → 发送回复
```

### 4. 回复发送流程

```
Pipeline → 调用渠道发送方法 → 抖音API → 发送成功/失败 → 记录日志
```

## 📝 待实现功能清单

### 高优先级 (P0)
- [x] 后端API连接Go服务
- [ ] 完善OAuth授权回调处理
- [ ] 实现私信消息监听
- [ ] 完善消息去重机制
- [ ] 实现自动回复开关
- [ ] 添加回复内容审核

### 中优先级 (P1)
- [ ] 添加消息队列（Redis）
- [ ] 实现回复失败重试
- [ ] 添加回复模板
- [ ] 实现关键词过滤
- [ ] 添加回复统计

### 低优先级 (P2)
- [ ] 实现多账号管理
- [ ] 添加回复延迟控制
- [ ] 实现智能回复策略
- [ ] 添加A/B测试

## 🚀 下一步行动

1. **完善后端API** - 连接Go服务和前端
2. **实现私信监听** - 添加私信消息轮询
3. **完善AI集成** - 优化Coze API调用
4. **实现自动回复** - 完善回复发送逻辑
5. **添加监控日志** - 记录关键操作

