# æ˜æ—¥ä»»åŠ¡æ¸…å• - æŠ–éŸ³æ¸ é“å®Œæ•´åŠŸèƒ½å®ç°

## ğŸ¯ ç›®æ ‡
å®ç°æŠ–éŸ³æ¸ é“ä»æ‰«ç æˆæƒåˆ°è‡ªåŠ¨å›å¤çš„å®Œæ•´é“¾è·¯ï¼š
1. âœ… æ‰«ç æˆæƒåˆ›å»ºè´¦å·
2. âœ… ç›‘å¬ç›´æ’­é—´äº‹ä»¶
3. âœ… ç›‘å¬çŸ­è§†é¢‘è¯„è®º
4. âœ… è‡ªåŠ¨å›å¤è¯„è®º
5. âœ… å‘é€ç§ä¿¡åŠŸèƒ½

## ğŸ“‹ è¯¦ç»†ä»»åŠ¡åˆ†è§£

### 1. æŠ–éŸ³å¼€æ”¾å¹³å°å®¡æ ¸è·Ÿè¿› â° 9:00-10:00
- [ ] æ£€æŸ¥ä¼ä¸šä¸»ä½“è®¤è¯å®¡æ ¸çŠ¶æ€
- [ ] ç¡®è®¤ App ID å’Œ App Secret æ˜¯å¦å·²ä¸‹å‘
- [ ] é…ç½® OAuth å›è°ƒåœ°å€
- [ ] æµ‹è¯•æˆæƒ URL ç”Ÿæˆ

### 2. å‰ç«¯æ‰«ç æˆæƒåŠŸèƒ½å¢å¼º â° 10:00-12:00
- [ ] ä¼˜åŒ–æ‰«ç æˆæƒæµç¨‹
- [ ] æ˜¾ç¤ºæˆæƒçŠ¶æ€å’Œè¿›åº¦
- [ ] å¤„ç†æˆæƒå¤±è´¥æƒ…å†µ
- [ ] ä¿å­˜æˆæƒæˆåŠŸåè¿”å›çš„è´¦å·ä¿¡æ¯

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `frontend/src/pages/Channels/DouyinPage.tsx`
- `frontend/src/services/api.ts`

**å…³é”®å®ç°**ï¼š
```typescript
// 1. è°ƒç”¨ Go ä»£ç†æœåŠ¡è·å–æˆæƒ URL
const authURL = await api.get('/proxy/oauth/douyin');

// 2. åœ¨ Modal ä¸­æ˜¾ç¤ºäºŒç»´ç 
<QRCode value={authURL} />

// 3. è½®è¯¢æ£€æŸ¥æˆæƒçŠ¶æ€
const checkAuthStatus = async () => {
  const { code } = await api.get('/proxy/oauth/callback');
  if (code) {
    // ä¿å­˜è´¦å·ä¿¡æ¯
    await saveAccount({ access_token, user_info });
  }
};
```

### 3. Go ä»£ç†æœåŠ¡ - OAuth æµç¨‹å®ç° â° 13:00-15:00
- [ ] å®Œå–„ OAuth æˆæƒæµç¨‹
- [ ] å®ç° token æ¢å–é€»è¾‘
- [ ] è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] ä¿å­˜è´¦å·åˆ°æ•°æ®åº“

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `proxy/oauth/oauth.go`
- `proxy/main.go`

**å…³é”®å®ç°**ï¼š
```go
// 1. ç”Ÿæˆæˆæƒ URL
func (o *DouyinOAuth) GetAuthURL() string {
    params := url.Values{}
    params.Set("client_key", o.AppID)
    params.Set("response_type", "code")
    params.Set("scope", "user_info,video.list,video.comment")
    params.Set("redirect_uri", o.RedirectURI)
    return fmt.Sprintf("https://open.douyin.com/platform/oauth/connect/?%s", params.Encode())
}

// 2. æ¢å–è®¿é—®ä»¤ç‰Œ
func (o *DouyinOAuth) ExchangeCodeForToken(code string) (*OAuthToken, error) {
    // è°ƒç”¨æŠ–éŸ³ API æ¢å– token
    resp, err := http.PostForm("https://open.douyin.com/oauth/access_token/", data)
    // è§£æè¿”å›çš„ token
}

// 3. è·å–ç”¨æˆ·ä¿¡æ¯
func (o *DouyinOAuth) GetUserInfo(accessToken string) (*UserInfo, error) {
    // è°ƒç”¨æŠ–éŸ³ API è·å–ç”¨æˆ·ä¿¡æ¯
}
```

### 4. ç›´æ’­é—´äº‹ä»¶ç›‘å¬ â° 15:00-17:00
- [ ] å®ç°çœŸå® WebSocket è¿æ¥
- [ ] è§£ææŠ–éŸ³ WebSocket åè®®
- [ ] å¤„ç†å„ç§äº‹ä»¶ç±»å‹ (è¯„è®ºã€ç‚¹èµã€å…³æ³¨ç­‰)
- [ ] äº‹ä»¶æ•°æ®æ¨é€åˆ°åç«¯

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `proxy/channel/douyin.go`

**å…³é”®å®ç°**ï¼š
```go
// 1. è¿æ¥æŠ–éŸ³ WebSocket
func (d *DouyinChannel) connectWebSocket() error {
    wsURL := fmt.Sprintf("wss://live.douyin.com/webcast/im/push/v2/?room_id=%s&app_id=%s", d.roomID, d.appID)
    
    headers := http.Header{}
    headers.Set("Authorization", "Bearer " + d.accessToken)
    
    d.conn, _, err = websocket.DefaultDialer.Dial(wsURL, headers)
    return err
}

// 2. è¯»å–æ¶ˆæ¯
func (d *DouyinChannel) readMessages() {
    for {
        _, message, err := d.conn.ReadMessage()
        if err != nil {
            // é”™è¯¯å¤„ç†
            continue
        }
        
        // è§£ææ¶ˆæ¯
        event := d.parseDouyinMessage(message)
        
        // æ¨é€åˆ°åç«¯
        d.pipeline.ProcessEvent(event)
    }
}

// 3. è§£ææŠ–éŸ³æ¶ˆæ¯æ ¼å¼
func (d *DouyinChannel) parseDouyinMessage(data []byte) *event.Event {
    // æ ¹æ®æŠ–éŸ³åè®®è§£ææ¶ˆæ¯
    // æ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼šcomment, like, follow, enter, gift ç­‰
}
```

### 5. çŸ­è§†é¢‘è¯„è®ºç›‘å¬ â° 17:00-18:00
- [ ] å®ç°è¯„è®ºè½®è¯¢æœºåˆ¶
- [ ] è°ƒç”¨æŠ–éŸ³ API è·å–è¯„è®º
- [ ] å¤„ç†æ–°è¯„è®ºäº‹ä»¶
- [ ] æ¨é€åˆ°åç«¯å¤„ç†

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `proxy/channel/douyin.go`

**å…³é”®å®ç°**ï¼š
```go
// 1. è½®è¯¢çŸ­è§†é¢‘è¯„è®º
func (d *DouyinChannel) pollVideoComments() {
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            // è·å–è§†é¢‘è¯„è®º
            comments, err := d.getVideoComments(d.videoID)
            if err != nil {
                continue
            }
            
            // å¤„ç†æ–°è¯„è®º
            for _, comment := range comments {
                evt := event.NewEvent("video_comment", "douyin", d.videoID, comment.UserID, comment.Nickname)
                evt.SetContent(comment.Content)
                
                d.pipeline.ProcessEvent(evt)
            }
        }
    }
}

// 2. è°ƒç”¨æŠ–éŸ³ API è·å–è¯„è®º
func (d *DouyinChannel) getVideoComments(videoID string) ([]VideoComment, error) {
    url := fmt.Sprintf("https://open.douyin.com/api/v1/video/comment/list/?video_id=%s", videoID)
    
    req, _ := http.NewRequest("GET", url, nil)
    req.Header.Set("Authorization", "Bearer " + d.accessToken)
    
    resp, err := http.DefaultClient.Do(req)
    // è§£æè¿”å›çš„è¯„è®ºæ•°æ®
}
```

### 6. è‡ªåŠ¨å›å¤è¯„è®ºåŠŸèƒ½ â° 18:00-19:00
- [ ] è°ƒç”¨æŠ–éŸ³ API å‘é€è¯„è®ºå›å¤
- [ ] å¤„ç†è¯„è®ºæƒé™æ£€æŸ¥
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [ ] è®°å½•å›å¤æ—¥å¿—

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `proxy/channel/douyin.go`
- `proxy/pipeline/pipeline.go`

**å…³é”®å®ç°**ï¼š
```go
// 1. å‘é€è¯„è®ºå›å¤
func (d *DouyinChannel) SendVideoCommentReply(commentID, content string) error {
    url := "https://open.douyin.com/api/v1/video/comment/reply/"
    
    data := map[string]interface{}{
        "video_id":   d.videoID,
        "comment_id": commentID,
        "content":    content,
    }
    
    // è°ƒç”¨æŠ–éŸ³ API
    resp, err := d.callDouyinAPI("POST", url, data)
    
    // è®°å½•å›å¤æ—¥å¿—
    log.Printf("ğŸ“¤ æŠ–éŸ³è¯„è®ºå›å¤: %s", content)
    
    return err
}

// 2. åœ¨ Pipeline ä¸­å¤„ç†è‡ªåŠ¨å›å¤
func (p *Pipeline) ProcessEvent(evt *event.Event) error {
    // 1. è°ƒç”¨ AI ç”Ÿæˆå›å¤
    reply, err := p.generateAIReply(evt)
    if err != nil {
        return err
    }
    
    // 2. è°ƒç”¨æ¸ é“æ¥å£å‘é€å›å¤
    if evt.Type == "video_comment" {
        return p.channel.SendVideoCommentReply(evt.Metadata["comment_id"], reply)
    }
    
    return nil
}
```

### 7. å‘é€ç§ä¿¡åŠŸèƒ½ â° 19:00-20:00
- [ ] å®ç°å‘é€ç§ä¿¡æ¥å£
- [ ] æ£€æŸ¥æƒé™å’Œé™åˆ¶
- [ ] å¤„ç†æ•æ„Ÿè¯è¿‡æ»¤
- [ ] è®°å½•ç§ä¿¡æ—¥å¿—

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `proxy/channel/douyin.go`

**å…³é”®å®ç°**ï¼š
```go
// å‘é€ç§ä¿¡
func (d *DouyinChannel) SendPrivateMessage(userID, content string) error {
    url := "https://open.douyin.com/api/v1/message/send/"
    
    data := map[string]interface{}{
        "user_id": userID,
        "content": content,
        "type":    "text",
    }
    
    // è°ƒç”¨æŠ–éŸ³ API
    resp, err := d.callDouyinAPI("POST", url, data)
    
    // è®°å½•ç§ä¿¡æ—¥å¿—
    log.Printf("ğŸ“¤ æŠ–éŸ³ç§ä¿¡: user_id=%s, content=%s", userID, content)
    
    return err
}
```

### 8. æµ‹è¯•å®Œæ•´æµç¨‹ â° 20:00-21:00
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•æˆæƒæµç¨‹
- [ ] æµ‹è¯•ç›´æ’­é—´äº‹ä»¶ç›‘å¬
- [ ] æµ‹è¯•çŸ­è§†é¢‘è¯„è®ºç›‘å¬
- [ ] æµ‹è¯•è‡ªåŠ¨å›å¤åŠŸèƒ½
- [ ] æµ‹è¯•ç§ä¿¡å‘é€åŠŸèƒ½
- [ ] è®°å½•é—®é¢˜å’Œ bug

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### æŠ–éŸ³ API è°ƒç”¨è§„èŒƒ
```bash
# 1. è¯·æ±‚å¤´å¿…é¡»åŒ…å«è®¤è¯ä¿¡æ¯
Authorization: Bearer {access_token}

# 2. é¢‘ç‡é™åˆ¶
- å•åº”ç”¨ QPS: 20
- æ—¥è°ƒç”¨ä¸Šé™: 100ä¸‡æ¬¡

# 3. é”™è¯¯å¤„ç†
- 400: è¯·æ±‚å‚æ•°é”™è¯¯
- 401: è®¤è¯å¤±è´¥ï¼Œéœ€è¦åˆ·æ–° token
- 429: é¢‘ç‡è¶…é™ï¼Œéœ€è¦é™é€Ÿ
- 500: æœåŠ¡å™¨é”™è¯¯ï¼Œéœ€è¦é‡è¯•
```

### WebSocket è¿æ¥è¦ç‚¹
```go
// 1. å¿ƒè·³æœºåˆ¶
pingPeriod := 30 * time.Second
ticker := time.NewTicker(pingPeriod)

// 2. è‡ªåŠ¨é‡è¿
if err := d.conn.ReadMessage(); err != nil {
    // ç­‰å¾… 5 ç§’åé‡è¿
    time.Sleep(5 * time.Second)
    d.connectWebSocket()
}

// 3. æ¶ˆæ¯é˜Ÿåˆ—
// ä½¿ç”¨ channel ç¼“å†²æ¶ˆæ¯ï¼Œé¿å…é˜»å¡
```

### AI å›å¤ç­–ç•¥
```go
// 1. æ„å›¾è¯†åˆ«
intent := identifyIntent(event.Content)

// 2. é€‰æ‹©å›å¤ç­–ç•¥
switch intent {
case "price_inquiry":
    reply = "æ‚¨å¥½ï¼Œä»·æ ¼è¯·å’¨è¯¢å®¢æœå¾®ä¿¡ï¼šxxx"
case "product_question":
    reply = generateAIReply(event.Content)
default:
    reply = "æ„Ÿè°¢æ‚¨çš„å…³æ³¨ï¼Œç¨åä¸ºæ‚¨è¯¦ç»†è§£ç­”"
}

// 3. å†…å®¹å®¡æ ¸
if isSensitive(reply) {
    reply = "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜"
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™ç”³è¯·
- ç¡®ä¿ç”³è¯·äº†æ‰€éœ€çš„ API æƒé™
- éƒ¨åˆ†åŠŸèƒ½å¯èƒ½éœ€è¦å•ç‹¬ç”³è¯·æƒé™

### 2. é¢‘ç‡é™åˆ¶
- éµå®ˆæŠ–éŸ³ API è°ƒç”¨é¢‘ç‡é™åˆ¶
- å®ç°è¯·æ±‚é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶

### 3. é”™è¯¯å¤„ç†
- å®Œå–„çš„é”™è¯¯æ—¥å¿—
- ä¼˜é›…çš„é™çº§æœºåˆ¶
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 4. å®‰å…¨åˆè§„
- éµå¾ªæŠ–éŸ³å¼€æ”¾å¹³å°ä½¿ç”¨è§„èŒƒ
- ä¸å‘é€åƒåœ¾æ¶ˆæ¯
- ä¿æŠ¤ç”¨æˆ·éšç§

## ğŸ“Š é¢„æœŸæˆæœ

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ‰«ç æˆæƒæˆåŠŸç‡ 100%
- âœ… äº‹ä»¶ç›‘å¬ç¨³å®šç‡ 99%+
- âœ… è‡ªåŠ¨å›å¤å‡†ç¡®ç‡ 85%+
- âœ… ç§ä¿¡å‘é€æˆåŠŸç‡ 95%+

### æ€§èƒ½æŒ‡æ ‡
- äº‹ä»¶å¤„ç†å»¶è¿Ÿ < 1 ç§’
- AI å›å¤ç”Ÿæˆæ—¶é—´ < 3 ç§’
- ç³»ç»Ÿå¯ç”¨æ€§ 99%+

### ç”¨æˆ·ä½“éªŒ
- æˆæƒæµç¨‹æµç•…
- å›å¤åŠæ—¶å‡†ç¡®
- ç•Œé¢å‹å¥½ç›´è§‚

## ğŸ¯ æ˜å¤©è§ï¼

ä¸»å…¬ï¼Œè¿™ä¸ªä»»åŠ¡æ¸…å•æ¶µç›–äº†æŠ–éŸ³æ¸ é“å®Œæ•´åŠŸèƒ½çš„æ‰€æœ‰å…³é”®ç¯èŠ‚ã€‚æ˜å¤©æŒ‰ç…§è¿™ä¸ªè®¡åˆ’æ¨è¿›ï¼Œä¸€å®šèƒ½å®ç°å®Œæ•´çš„æŠ–éŸ³æ¸ é“å¯¹æ¥åŠŸèƒ½ï¼

**å‡†å¤‡å¥½å¤§å¼€æ€æˆ’ï¼ğŸš€**
