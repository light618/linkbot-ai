# 内网穿透配置指南

## 🎯 问题说明

主公说得对！抖音服务器无法访问 `localhost:8080`，需要配置公网可访问的地址。

## ✅ 解决方案

### 方案A：ngrok（推荐用于测试）

#### 1. 安装 ngrok
```bash
# macOS
brew install ngrok

# 或直接下载
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-arm64.zip
unzip ngrok-v3-stable-darwin-arm64.zip
sudo mv ngrok /usr/local/bin/
```

#### 2. 启动 ngrok
```bash
ngrok http 8080
```

#### 3. 获取公网地址
ngrok 会显示类似：
```
Forwarding: https://abc123.ngrok-free.app -> http://localhost:8080
```

#### 4. 配置回调地址
在 `.env` 文件中修改：
```bash
DOUYIN_REDIRECT_URI=https://abc123.ngrok-free.app/oauth/callback
```

#### 5. 在抖音开放平台配置
登录抖音开放平台 → 应用管理 → 配置回调地址：
```
https://abc123.ngrok-free.app/oauth/callback
```

### 方案B：Cloudflare Tunnel（推荐用于生产）

#### 1. 安装 cloudflared
```bash
brew install cloudflared
```

#### 2. 启动隧道
```bash
cloudflared tunnel --url http://localhost:8080
```

#### 3. 获取地址
类似：`https://random-word-1234.trycloudflare.com`

### 方案C：部署到服务器（推荐用于生产）

#### 1. Railway 部署
```bash
# 部署到 Railway（自动分配公网域名）
railway up
```

#### 2. 自定义域名
```bash
# 配置自定义域名
railway domains add api.linkbot-ai.com
```

#### 3. 配置回调地址
```bash
DOUYIN_REDIRECT_URI=https://api.linkbot-ai.com/oauth/callback
```

## 🔧 当前配置

### 环境变量
```bash
# .home/linkbot-ai/.env
DOUYIN_APP_ID=aw6hj204nms0vumu
DOUYIN_APP_SECRET=b46cd587e094aae751e45380f9c0e72d
DOUYIN_REDIRECT_URI=http://localhost:8080/oauth/callback  # ⚠️ 需要改为公网地址
```

### 需要修改为
```bash
# 使用 ngrok
DOUYIN_REDIRECT_URI=https://abc123.ngrok-free.app/oauth/callback

# 或使用 Railway
DOUYIN_REDIRECT_URI=https://your-app.railway.app/oauth/callback
```

## 🚀 快速开始

### 步骤1：启动 ngrok
```bash
ngrok http 8080
```

### 步骤2：获取地址
复制显示的 `https://xxx.ngrok-free.app` 地址

### 步骤3：配置环境变量
```bash
# 修改 .env 文件
DOUYIN_REDIRECT_URI=https://xxx.ngrok-free.app/oauth/callback
```

### 步骤4：重启服务
```bash
pkill live-im-proxy
DOUYIN_REDIRECT_URI=https://xxx.ngrok-free.app/oauth/callback ./live-im-proxy
```

### 步骤5：测试
```bash
# 访问（应该重定向到抖音授权页面）
https://xxx.ngrok-free.app/oauth/douyin
```

## ⚠️ 注意事项

### ngrok 免费版限制
1. **动态地址** - 每次重启地址会变
2. **访问限制** - 有访问次数限制
3. **带宽限制** - 限制带宽

### 生产环境建议
1. 使用固定域名（Railway + 自定义域名）
2. 配置 SSL 证书
3. 使用稳定的内网穿透服务

## 🎯 下一步

主公，您现在有两个选择：

### 选择1：快速测试（使用 ngrok）
```bash
# 1. 启动 ngrok
ngrok http 8080

# 2. 获取地址
# 复制 https://xxx.ngrok-free.app

# 3. 重新配置
# 修改环境变量，重启服务

# 4. 在抖音开放平台配置回调地址
```

### 选择2：部署到 Railway（推荐）
```bash
# 1. 部署到 Railway
railway up

# 2. 获取公网域名
# 类似：https://your-app.up.railway.app

# 3. 配置回调地址
# 在抖音开放平台配置

# 4. 开始测试
```

主公，您想用哪种方案？我建议先用 ngrok 快速测试，验证功能后再部署到 Railway。

---

**状态**：等待选择方案  
**下一步**：配置公网回调地址
